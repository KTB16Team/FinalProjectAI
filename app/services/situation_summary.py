def situation_summary_GPT(text):
    return ""

def stt_model(link):
    return "text"

def generate_response(text):
    return "entities"


import json
#%%
import sys
import os
import pickle
import json
import ast
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from dotenv import load_dotenv
import openai
#%%
# OPENAI_API_KEY
load_dotenv()
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
client = openai.OpenAI(
    api_key = OPENAI_API_KEY,
)

def test_response(ref_text):
    llm = ChatOpenAI(model='gpt-4o', temperature=0.3)
    # Combined prompt template for summarization and evaluation
    combined_textbook = '''
    situation : {situation}
    당신은 일반적인 사회 통념 관점에서 대화의 요약과 판결을 제공하는 중재자 판사입니다.
    다음 situation의 내용의 대화를 검토하고 모든 정보를 세부적으로 평가하여 아래에 요청된 정보들을 작성하세요.
    1. "title"
    : "사건 제목 (대화의 주제를 반영)"
    2. situation_summary
    : 사용자가 제공한 situation의 상황을 요약합니다.
        - 사용자는 A로 변경합니다.
        - 사용자와 대화하는 사람은 B로 변경합니다.
        - 그 외 등장 인물은 C,D,E와 같은 알파벳으로 변경합니다.
        - 요약할 때 각 사용자의 중요한 사건들이 사라지는 것을 지양해야합니다.
        - 최대한 객관적인 입장에서 내용을 요약합니다.
    2. stance_plaintiff
    : 사용자가 제공한 situation 내용을 A의 입장에서 요약합니다.
        - 각 사용자의 감정 변화를 반영하여 각 사용자의 입장에서 상황을 요약합니다.
        - 이때 반드시 사용자의 감정 변화에 영향을 미친 사건들이 사라지는 것을 막습니다
        - 원고(A)의 입장 설명 A의 시각에서 바라본 상황
        - A가 주장하는 사건의 핵심 요점
        - 대화 중 강조하는 감정과 이슈
    위의 내용을 stance_plaintiff에 저장합니다.
    3. stance_defendant
    : 사용자가 제공한 situation 내용을 B의 입장에서 요약합니다.
        - 각 사용자의 감정 변화를 반영하여 각 사용자의 입장에서 상황을 요약합니다.
        - 이때 반드시 사용자의 감정 변화에 영향을 미친 사건들이 사라지는 것을 막습니다
        - 피고(B)의 입장 설명 B의 시각에서 바라본 상황
        - B가 주장하는 사건의 핵심 요점
        - 대화 중 강조하는 감정과 이슈
    위의 내용을 stance_defendant에 저장합니다.
    4. judgement
    : 대화를 기반으로 한 최종 판결로, 각 주요 행동과 대화에서의 역할을 평가하여 판단한 결과. 사건의 결론과 필요한 경우 피고 및 원고에게 추천하는 행동 방안을 포함
    5. fault_rate
    : 과실 비율(숫자로 기재): 전체 사건에 대한 A의 과실 비율로, 분쟁에서 A의 책임 정도를 수치화한 것
    출력 방식은 다음과 같습니다:
    - json형식이다.
    - {{
      "stance_plaintiff": "원고(작성자) 입장",
      "stance_defendant": "피고(상대방) 입장",
      "summary_ai": "상황 요약문(AI)",
      "judgement": "판결문",
      "fault_rate": 57.8''
      "title": "사건 제목 (대화의 주제를 반영)}} ]
    '''
    prompt = ChatPromptTemplate.from_template(combined_textbook)

    chain = prompt | llm | StrOutputParser()

    response = chain.invoke({
        'situation': ref_text
    })
    cleaned_data = response.replace('json', '').replace('```', '').strip()
    situations = json.loads(cleaned_data)

    return situations

test_Case1 = '''
A: 또 30분이나 늦었네. 우리가 몇 시에 만나기로 했는지 기억해?

B: 차가 막혀서 어쩔 수 없었어. 미리 연락했잖아. 정말 빨리 오려고 했다고.

A: 그거야 그렇지. 근데 벌써 몇 번째야? 매번 이렇게 기다리게 하면, 나도 지치는 거 몰라?

B: 미안하다고 했잖아. 일부러 늦은 것도 아니고… 상황이 어쩔 수 없었다니까.

A: ‘어쩔 수 없었다’는 말 이제 그만 좀 듣고 싶어. 너는 항상 변명만 늘어놓고, 내가 매번 이해해야 한다고만 생각하는 거 같아.

B: 아니야, 진짜 사정이 있었으니까 그런 거잖아. 이해해줄 수 없는 거야?

A: 그럼, 네가 계속 이렇게 반복해서 늦을 때마다 내가 이해만 해야 하는 거야? 네가 얼마나 기다리게 하는 건지, 그동안 내가 어떻게 느끼는지 알기나 해?

B: 나도 불편한데… 진짜 상황이 그랬으니까 어쩔 수 없다고 이해해줬으면 좋겠어. 기다리는 게 싫으면 딱히 억지로 기다릴 필요도 없었잖아.

A: 억지로 기다렸다고 생각해? 그게 무슨 말이야? 너를 만나고 싶어서, 시간 맞춰 나오고 기다린 건데… 그게 억지라니. 그러면 차라리 네가 시간을 더 맞추려고 노력했어야지.

B: 무슨 소리야, 나도 노력했어. 매번 늦고 싶은 게 아니라고. 근데 내가 뭘 할 수 있었겠어? 차가 막혀서 그랬는데 내가 어떻게 했어야 했는데?

A: 시간 약속이 중요하다면, 애초에 일찍 출발하거나, 방법을 미리 생각해봤겠지. 언제나 ‘어쩔 수 없었다’는 말만 하니까 신뢰가 떨어지는 거잖아.

B: 그래, 내가 매번 늦었던 건 아니잖아. 오늘은 상황이 안 좋았던 거지. 그리고 그런 말을 듣는 것도 나로선 부담스러워. 네가 날 전혀 이해 안 해주는 것 같아서…

A: 네가 그러는 것처럼 나도 사정이 있겠지. 근데 내가 항상 네 입장을 이해해야 해? 나도 네가 기다리는 거 신경 써줬으면 좋겠는데 그게 그렇게 힘든 거야?

B: 너도 내가 왜 늦었는지 이해해줘야지. 내 입장도 생각해주고, 상황이 어쩔 수 없는 건 받아들일 수 있는 거잖아. 계속 이렇게 불만을 쌓아가는 게 너한테도 좋은 건 아니라고 생각해.

A: 난 네가 늦는 거보다 항상 이유를 찾아내서 자기 입장만 고집하는 게 더 답답해. 그럴 때마다 내가 무슨 생각을 하는지 네가 전혀 관심 없어 보여.

B: 그러면 매번 무조건 미안하다고만 할 수는 없잖아. 나도 진짜 노력을 하고 있는데, 네가 자꾸 이 문제로 날 몰아붙이면 솔직히 화도 나고 힘들어.

A: 이해 못할 것도 없겠지, 근데 네가 나한테 더 관심을 두고 노력했다면 이런 일이 없었을 거야. 우리는 약속할 때마다 반복되는 일이니까 그만큼 중요하게 생각해줬으면 좋겠어.

B: 자꾸 이렇게 나한테만 불만을 쌓아놓으면 그게 정말 좋은 관계를 유지할 수 있는 방법이라고 생각해?

A: 난 노력하라고 계속 말하는 거야. 그렇지 않고서는 넌 더 이해 못할 거 같아서… 이런 상황이 계속 반복되면 결국 우리 둘 다 지칠 거야.

B: 정말 내가 널 이해 못 한다는 말밖에 안 들리네. 난 이게 내 잘못인 줄 알고 미안해하려고 해도 네가 그럴수록 더 부담돼.

A: 이해 못하는 게 아니잖아, 그냥 내가 말한 것처럼 실수하고 있는 걸 알고 그 부분을 조심하자는 건데… 그런 게 어렵다고 생각해?

B: 나도 최대한 네 입장을 생각하겠지만, 그럼 너도 내 상황을 한 번만이라도 이해해주는 게 그렇게 어려워?

A: 그럼 네 말대로 무조건 이해해줄게. 네가 시간을 아무리 늦어도 다 이해하고 받아들이면 되겠네. 그래, 이렇게 하면 해결이 되긴 할 거야.

B: 진짜로 그렇게 생각하는 거야? 그냥 네가 원하는 대로 난 이해만 하고 넘어가야 한다는 거야?

A: 뭐, 그게 서로를 위해서라면 할 수도 있지. 문제는 네가 먼저 그렇게 하려고 하지 않았다는 거잖아. 그래도 난 널 배려하려고 노력했어.

B: 배려는 양쪽이 다 해야 하는 거야. 내 입장에서도 너의 기분을 생각하려고 했는데, 네가 내 마음을 이해해주지 않으니까 힘들다고 느껴지는 거잖아.

A: 그렇다면 난 매번 네가 하는 걸 받아들여야 하고, 너는 그대로 남아도 된다는 거네? 그게 무슨 관계야?

B: 너도 참… 그렇게 모든 게 네 말대로만 가야 하는 거야? 난 노력하려는 것 자체를 말하는 건데.

A: 그러면 내 말대로 안 할 거야? 어떻게 해야 네가 이해할 건데?

B: 그건 서로 이해하고 맞춰가는 거야. 계속 서로가 받아들일 수 있게… 말로만 이해하라는 건 다 의미 없어져.
A: 그럼 네 말대로 난 그냥 너한테 맞추고, 계속 이해만 해야 하는 거네? 그래, 그렇게 하면 되겠네. 네가 늦고, 매번 변명하고, 난 그냥 받아들이고… 이게 다야?

B: 왜 그렇게 비꼬는 거야? 나도 이 상황이 힘들다고. 내 입장은 생각 안 하고 무조건 내 잘못만 강조하는 거 정말 지쳤어.

A: 지쳤다고? 나는 안 지쳤겠어? 매번 같은 이유로 기다리고, 화내면 네 입장 생각해줘야 하고, 결국 내가 이해하라는 거잖아. 이게 반복되니까 더 힘들어.

B: 그래서 너는 모든 잘못이 다 내 탓이라고 생각하는 거야? 그럼 이제 뭐 어쩌자는 거지? 계속 이 얘기만 하고 있을 거야?

A: 내가 내 입장을 말하면 왜 매번 네가 억울해 하는지 모르겠어. 그렇게 힘들면 처음부터 시간을 맞췄어야지. 애초에 약속 시간 안 지키는 게 문제인 거잖아.

B: 그럼 넌 한 번이라도 내가 왜 늦는지 이해하려고 했어? 차가 막혔고, 진짜 어쩔 수 없는 상황도 있었는데… 날 한 번이라도 이해하려고 노력은 했어?

A: 이해해주려고 했지. 근데 너는 왜 매번 똑같은 핑계야? 차가 막혔다는 변명으로 계속 반복되는 게 너는 이해가 돼?

B: 알겠어, 알겠다고. 그러면 내가 항상 틀렸고, 네가 옳다는 말이야? 난 진짜 지쳤어, 더 이상 말하기도 싫어.

A: 그래, 그럼 더 얘기 안 할게. 어차피 얘기해봤자 네가 듣지 않는 것 같으니까.

B: 어, 나도 그래. 네 말 다 들어봤으니까… 이제 뭐 더 말할 것도 없겠네.

A: 네가 이해하든 말든 상관없어. 이런 식으로 하면 우리 그냥 끝나는 거야. 이 얘기를 계속해도 달라질 게 없으니까.

B: 좋아, 그럼 여기서 끝내. 나도 이제는 진짜 이게 맞는 건가 싶어. 너도 집에 가.

A: 좋아, 나도 집에 갈게. 이젠 할 말도 없어.

B: 그래, 가라.

A: 어차피 너도 나도 해결할 생각 없으니까, 그냥 끝내자.

B: 그렇게 말하고 싶으면 그렇게 하자고.

A: 그럼, 나 간다.

B: 어, 나도 갈 거니까 더 이상 말하지 마.'''
